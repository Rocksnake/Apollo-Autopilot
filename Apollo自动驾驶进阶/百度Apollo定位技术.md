# 无人车定位技术

> 相对一个坐标系，无人车的自定位系统知道汽车的位置和姿态

**坐标系的选定**：

* 局部坐标系

* 全局坐标系

**自定位系统输出信息**：

|  项目  |       内容       | 自由度 |
| :----: | :--------------: | :----: |
|  位置  |     X、Y、X      |   3    |
|  姿态  | Yaw、Pitch、Roll |   3    |
|  速度  |    Vx、Vy、Vz    |   3    |
| 加速度 |    ax、ay、az    |   3    |
| 角速度 |    wx、wy、wz    |   3    |

**定位指标：**

|  项目  |   指标   | 理想值 |
| :----: | :------: | :----: |
|  精度  | 误差均值 | <10cm  |
| 鲁棒性 | 最大误差 | <30cm  |
|  场景  | 覆盖场景 | 全天候 |

## 如何定位

* 基于电子信号的定位
  * 基于电子信号的定位方法中最有特点的就是GNSS（全球导航卫星系统）。它的作用机制是通过一组卫星的伪距、星历、卫星发射时间等观测量，以及用户钟差，得知你现在大概的位置。

* 航迹的推算
  * 航迹推算最有特点的就是IMU。航迹推算就是根据上一时刻“我“的”位置“和”姿态“，叠加一些测量信息可以知道现在的”位置“和”姿态“。IMU是一个惯性测量单元。它包含了加速度计和陀螺仪。加速度计会输出加速度的信息。但是不止加速度，它还包含重力加速度。陀螺仪是一个旋转，即是前面所讲到三个轴上的一个旋转。

* 环境特征的匹配
  * 环境特征匹配相对较多，比如LiDAR的匹配。在建好了点云定位的地图，将LIDAR的数据和已建好的地图做匹配，以此来计算自己的位置。或者通过摄像头，知道了一些车道线，红绿灯的标志，然后确定自身的位置。

同样的我们也会基于基站运用差分技术，从而提高定位的精度，差分技术分为物理差分和距离差分两种，距离差分又分为伪距差分和载波相位差分。

* 伪距差分的精度不会特别的高，大概在米级的这么一个量级，还不能满足要求。因此发展出实时动态的载波相位差分。

* 载波相位差分最主要的是要估计一个载波相位的一个整周，定位精确基本上是在厘米级（小于5厘米）。

## 定位方法

1. **激光定位**：
   * 激光定位是预先制作一个地图，不管是3D的Voxel地图或者是点云地图，又或者是2D的概率地图。
   * 2D概率地图是把所有的这个点云数据铺到一块，压成了一个2D地图。2D地图分成很多小格子，每个格子里面存储了颜色信息，位置。位置上面可能只存Z的这个维度，因为2D地图有XY。
   * 另外，还包括一些概率，概率和点云的数量以及分布相关。拿实时的激光点云和这个地图去做匹配。
2. **视觉定位**：
   * 对于视觉定位，如果照明环境变化越大，例如这次跑过去的光照度和下次跑过去的光照度不一样，视觉所受到的影响就越大。
   * 所以基于这种特征点的定位，比如SLAM里面用Relocalization并不是很合适用于车的视觉定位。因为下次可能检测不到那些特征，比如SIFT特征或者别的特征就会造成定位的失败。
   * 但是有一些特征具有明显Semantic意义，比如车道线或者旁边立的这些柱子，红绿灯的柱子或者红绿灯本身或者一些Traffic Sign之类的，对于定位而言非常有用。
3. **车道线检测**：
   * 需要先做好这种高精度地图，它里面包含车道线的信息，然后把每个线段两个端点拿出来。
   * 在线去跑的时候，车上这个摄像头会用深度学习的方式检查出这些车道线。
   * 车道线也是一段一段的，然后我们会去做匹配。匹配的方法有很多种。
4. **惯性导航**：
   * 惯性导航是基于IMU的，里面包含有加速度计和陀螺仪。
   * 加速度计会给提供瞬时的加速度，陀螺仪提供瞬时角速度。加速度计提供的不仅是加速度，还测量了重力加速度，所以用的时候需要先把重力加速度剔除掉。
   * IMU的工作过程：首先是角速度通过积分后得到一个姿态，并把它应用到加速度上，对加速度积分得到速度，再得到最后的位置。
   * 优点是可以得到一个六自由度的信息，不光是XYZ yaw之类，还有Roll和Pitch，是一个全量的信息。另外，它的短时精度非常高，比如十来万级别的设备，坚持五六百毫秒是没有问题的，它是很准的，包括在大机动的时候。
   * IMU的出频率非常的高，基本上都是200赫兹以上，这样有助于同步。因为它有精准的时间戳，它检测的数据传输过来之后可以精准知道它的时间戳，有精准的时间戳就可以给出精准的位姿，即它在全局坐标系下有自己的位置。
   * IMU是一个很独立的一个设备，没有外部依赖，使用自己的输入就可以。但是缺点也很明显，例如十几万的设备也就坚持几百毫秒，对于自动驾驶汽车是远远不够的。

前面介绍了GNSS定位、激光定位、视觉定位还有惯性导航，这四种定位方式都有各自的特点。如果把它们放到一块就可以做到一个很好的系统——多传感器融合定位。

5. **多传感器融合定位**：
   * 多传感器融合定位的核心是中间的卡尔曼滤波器，这是一个状态误差的卡尔曼滤波器。
   * 该滤波器接收惯性导航输出的递推，作为它的时间更新，保证滤波器往前走和高频的输出。还接受GPS、激光点云定位，或者是视觉定位的输出去做低频的状态更新。

## 坐标系

1. 地心惯性坐标系
2. 当地水平坐标系
3. 车体坐标系
4. IMU坐标系、相机坐标系、激光雷达坐标系

# 百度无人车定位技术

## GNSS技术

> 针对GPS，定位、测速、授时

原理是测距，有三颗卫星就可以交会两点，舍弃外部的空间点就可以得到自己测绘这个点。但是一般情况下，由于钟差，一般需要四颗卫星去做误差剔除。

GNSS定位其实是单点定位，没有用到基站，它的精度一般是5到10米。为了能够得到更精准的定位精度，引入了一些更好的方式，如载波定位技术。

**在无人车中的作用：**

1. GPS授时
2. 制作高精度地图
3. RTK在线定位，作为定位的一个模块使用

GNSS定位的可靠性还存在问题，容易收到电磁环境干扰，且对于较差的环境影响较大。

## 载波技术

> 为了确定载波的整周数，消除噪声，达到更精准的定位

* RTK
* PPP

**RTK**

卫星把观测数据给基站，也给车端的移动站。基站根据多个卫星的钟差计算出误差项，然后把误差项传递给车端，车端用这个误差项消除观测误差，得到精准的位置。它的问题是硬件成本高，需要建基站，需要4G通信的链路，需要基站传数据。

**PPP**

可以简单理解为一个很强的单点，它有很多种基础基站的建设。这些基站通过卫星数据，把这些误差都在基站做分离处理，再传递给卫星。卫星已经做了误差的消除，再去对车端进行定位，得到一个非常高精度的定位信息。

## 激光点云定位算法框架

* 图像对齐
  * 用于航向角的优化。点云定位里面会输出四个维度的信息，XYZ和Yaw（航向角）
* SSD HF

首先做航向角的优化，然后SSD-HF做XY优化，Z则由定位地图提供。

> 定位地图是一种数据的的存储方式。

激光点云定位的输入还包括预测位姿和实时点云数据。输出信息将会给融合算法，进行更加精确的定位。

## 视觉定位技术

> 输出也是XYZ和Yaw，即位置和朝向。视觉定位通过摄像头识别图像中具有语义信息的稳定特征并与地图做匹配，得到位置和朝向信息。

**流程：**

1. 3D特征地图的离线的生成
2. 图像特征的检测
3. 数据的整合输出

首先是摄像头进行图像特征的检测，主要是进行车道线和杆状物的检测。通过GPS给出的初始位置，基于初始位置对3D地图和摄像头检查到的信息进行特征匹配。用IMU和轮速计去做姿势的预测，给出一个不错的姿势。最后的结果输出给融合模块，融合可以将GPS、视觉定位、IMU数据整合，优化定位结果并提供高频输出。